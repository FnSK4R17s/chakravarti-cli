# ADR 002: Container Isolation for Command Execution

## Status

Accepted

## Context

Chakravarti executes arbitrary commands generated by LLMs. These commands may include:

- File system modifications
- Package installations
- Build tool executions
- Test runs
- Network operations

We need to protect the host system and ensure reproducible execution environments.

## Decision

We will provide two sandbox modes:

### 1. Local Sandbox (Default)

Executes commands directly on the host system within a worktree:

```rust
pub struct LocalSandbox {
    working_dir: PathBuf,
}
```

**Use cases:**
- Development and testing
- Trusted specifications
- When Docker is unavailable
- Simple file operations

### 2. Docker Sandbox

Executes commands in an isolated container:

```rust
pub struct DockerSandbox {
    image: String,
    mounts: Vec<ContainerMount>,
    network: NetworkMode,
}
```

**Use cases:**
- Production deployments
- Untrusted specifications
- Reproducible builds
- Network isolation

### Configuration

Users can specify sandbox mode via CLI:

```bash
# Local execution (default)
ckrv run spec.yaml

# Docker execution
ckrv run spec.yaml --sandbox docker

# With custom image
ckrv run spec.yaml --sandbox docker --image my-build-image:latest
```

### Container Configuration

Default container setup:
- Mount working directory as `/workspace`
- Mount secrets directory (read-only)
- Network: bridge (can be restricted)
- No privileged access
- Resource limits (memory, CPU)

```rust
ContainerConfig {
    image: "rust:latest",
    working_dir: "/workspace",
    mounts: vec![
        Mount::bind(worktree, "/workspace").read_write(),
        Mount::bind(secrets_dir, "/secrets").read_only(),
    ],
    network: NetworkMode::Bridge,
    memory_limit: Some("4g"),
    cpu_limit: Some(2.0),
}
```

## Consequences

### Positive

- **Security**: Isolated execution prevents host system damage
- **Reproducibility**: Consistent container environment
- **Flexibility**: Choose isolation level based on trust
- **Portability**: Same behavior across systems

### Negative

- **Complexity**: Docker adds setup requirements
- **Performance**: Container overhead vs direct execution
- **Compatibility**: Some tools may behave differently in containers

### Neutral

- Requires Docker installation for full security
- Learning curve for container configuration

## Security Considerations

1. **Never run as root** in containers
2. **Limit network access** for untrusted specs
3. **Resource limits** prevent runaway processes
4. **Read-only mounts** for sensitive data
5. **No privileged containers** by default

## Alternatives Considered

### Process Isolation (seccomp, namespaces)

More lightweight but requires Linux-specific syscalls and root for setup.

### Virtual Machines

Maximum isolation but too heavy for iterative development.

### WASM Sandboxing

Promising but ecosystem maturity issues for system operations.

## References

- [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
- [Container Security](https://www.docker.com/resources/what-container-security/)
- [Principle of Least Privilege](https://en.wikipedia.org/wiki/Principle_of_least_privilege)
